<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mosaico Top - Ofertas</title>
    <link rel="icon" href="favicon.png" type="image/png">
    <style>
        /* CSS Básico e Estilos do Layout */
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen, Ubuntu, Cantarell, "Fira Sans", "Droid Sans", "Helvetica Neue", sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f4f4f4;
            color: #333;
        }

        .main-container {
            display: flex;
            flex-direction: column;
            min-height: 100vh;
            width: 100%;
        }

        /* --- Área Superior: Iframe --- */
        .iframe-section {
            flex: 1 1 65vh; /* Ocupa 65% da altura da tela, mas pode encolher se necessário */
            display: flex;
        }
        
        .iframe-section .widget-content {
            width: 100%;
            height: 100%;
        }

        .iframe-section iframe {
            width: 100%;
            height: 100%;
            border: none; /* Isso remove a borda padrão do iframe */
        }

        /* --- Área Inferior: Conteúdo (Banner) --- */
        .content-section {
            display: flex;
            justify-content: center;
            align-items: center;
            background-color: #ffffff;
            padding: 20px 20px; /* Reduzindo o padding para deixá-lo mais compacto */
            box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
            min-height: 20vh; /* Reduzindo a altura mínima para parecer um banner */
            text-align: center; /* Centralizando o conteúdo */
        }
        
        .content-wrapper {
            max-width: 650px;
            display: flex; /* Usando flexbox para alinhar imagem, texto e botão */
            flex-direction: column; /* Colocando os itens em coluna por padrão */
            align-items: center; /* Centraliza itens na coluna */
            gap: 15px; /* Espaçamento entre os itens */
            min-height: 120px; /* Garante que o layout não "pule" ao trocar de oferta */
        }

        /* Estilos para tela grande: alinhar horizontalmente */
        @media (min-width: 768px) {
            .content-wrapper {
                flex-direction: row; /* Alinha em linha em telas maiores */
                justify-content: center; /* Centraliza horizontalmente */
                align-items: center; /* Alinha verticalmente */
                text-align: left; /* Texto alinhado à esquerda para layout horizontal */
            }

            .content-wrapper .text-and-button {
                flex-grow: 1; /* Permite que o texto e o botão ocupem o espaço restante */
                margin-left: 20px; /* Espaçamento da imagem */
            }
        }

        .content-image {
            max-width: 120px; /* Largura da imagem do banner */
            height: auto;
            border-radius: 8px;
            flex-shrink: 0; /* Impede que a imagem encolha */
        }

        .content-text {
            font-size: 1em; /* Tamanho da fonte ligeiramente menor para banner */
            line-height: 1.4;
            margin: 0; /* Remove margem padrão */
        }

        /* Novo estilo para o título dentro da content-section */
        .content-title {
            font-size: 1.2em; /* Tamanho do título */
            font-weight: bold;
            margin-bottom: 5px; /* Espaço entre o título e a descrição */
            color: #222; /* Cor mais escura para destaque */
        }


        .cta-button {
            display: inline-block;
            background-color: #007BFF; /* Cor do botão - Azul */
            color: #ffffff;
            padding: 10px 25px; /* Padding do botão mais compacto */
            text-decoration: none;
            font-weight: bold;
            font-size: 0.9em; /* Tamanho do botão */
            border-radius: 5px;
            transition: background-color 0.3s ease;
            margin-top: 10px; /* Margem superior para separar do texto */
        }

        .cta-button:hover {
            background-color: #0056b3; /* Cor do botão ao passar o mouse */
        }

        /* Estilos para o Carregamento e Erro */
        .loading-container, .error-container {
            display: none; /* Escondido por padrão */
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            width: 100%;
            text-align: center;
            position: absolute; /* Para cobrir todo o conteúdo */
            top: 0;
            left: 0;
            background-color: rgba(255, 255, 255, 0.9);
            z-index: 10;
        }

        .loading-text, .error-text {
            font-size: 1.2em;
            color: #555;
            margin-bottom: 20px;
        }
        
        .retry-button {
            background-color: #4CAF50; /* Verde */
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1em;
            transition: background-color 0.3s ease;
        }

        .retry-button:hover {
            background-color: #45a049;
        }

        /* Animação de carregamento */
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border-left-color: #007BFF;
            animation: spin 1.2s linear infinite;
        }
        
    </style>
</head>
<body>
    <div class='main-container'>
        <div class='iframe-section' id='iframe-area'>
            <div class='widget-content'>
                <iframe src=""
                        width="100%"
                        height="100%"
                        title="Dica Top"
                        frameborder="0">
                </iframe>
            </div>
        </div>
        
        <div class='content-section' id='content-area'>
            <div class="content-wrapper">
                <img class="content-image" src="" alt=""/>
                
                <div class="text-and-button">
                    <h3 class="content-title"></h3>
                    <p class="content-text"></p>
                    
                    <a class="cta-button" href="">Veja Mais</a>
                </div>
                
            </div>
        </div>
    </div>
    
    <!-- Novo elemento para o estado de carregamento e erro -->
    <div class="loading-container" id="loading-container">
        <div class="spinner"></div>
        <p class="loading-text">Carregando dados...</p>
    </div>

    <div class="error-container" id="error-container">
        <p class="error-text">Não foi possível carregar os dados.</p>
        <button class="retry-button" id="retry-button">Tentar Novamente</button>
    </div>

    <script>
    // --- Funções Auxiliares para Análise de CSV ---
    function parseCsvLine(line) {
        const result = [];
        let inQuote = false;
        let currentField = '';
        for (let i = 0; i < line.length; i++) {
            const char = line[i];
            if (char === '"') {
                inQuote = !inQuote;
                if (!inQuote && line[i + 1] === '"') { 
                    currentField += '"';
                    i++;
                }
            } else if (char === ',' && !inQuote) {
                result.push(currentField.trim());
                currentField = '';
            } else {
                currentField += char;
            }
        }
        result.push(currentField.trim());
        return result;
    }

    document.addEventListener('DOMContentLoaded', function() {
        // URLs das planilhas
        const mainCsvUrl = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQyYX_HnpqLYNklSBCTsPcrMHvZHooQqG7fO8sd5bZ0I_gsDK3hHNEVWRT3VYRF8yG_eVjydaMe1-r6/pub?gid=0&single=true&output=csv";
        const offersCsvUrl = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQyYX_HnpqLYNklSBCTsPcrMHvZHooQqG7fO8sd5bZ0I_gsDK3hHNEVWRT3VYRF8yG_eVjydaMe1-r6/pub?gid=1150732258&single=true&output=csv";
        
        let offersData = [];
        const loadingContainer = document.getElementById('loading-container');
        const errorContainer = document.getElementById('error-container');
        const retryButton = document.getElementById('retry-button');

        function getIdFromUrl() {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get('id');
        }

        const idFromUrl = getIdFromUrl();

        if (!idFromUrl) {
            console.log("Nenhum ID encontrado na URL. O conteúdo original será mantido.");
            loadingContainer.style.display = 'none';
            errorContainer.style.display = 'none';
        }

        // --- Funções de Carregamento e Atualização ---
        function updateOffer() {
            // Exibe uma oferta aleatória da lista
            if (offersData.length === 0) {
                console.warn("Nenhuma oferta disponível para exibir.");
                return;
            }

            const randomIndex = Math.floor(Math.random() * offersData.length);
            const randomOffer = offersData[randomIndex];

            const contentTitleElement = document.querySelector('#content-area .content-wrapper .content-title');
            const contentText = document.querySelector('#content-area .content-wrapper .content-text');
            const contentImage = document.querySelector('#content-area .content-wrapper .content-image');
            const ctaButton = document.querySelector('#content-area .content-wrapper .cta-button');

            // Verifica se o objeto e as propriedades existem antes de tentar acessá-las
            if (randomOffer) {
                if (contentTitleElement) {
                    // Usa a chave exata 'item name' para o título da oferta
                    contentTitleElement.textContent = randomOffer['item name'] || "Oferta Especial";
                }
                if (contentText) {
                    // Limpa o conteúdo do parágrafo, já que a descrição não é necessária para o carrossel de ofertas
                    contentText.textContent = ""; 
                }
                if (contentImage) {
                    // Usa a chave exata 'img' para a imagem da oferta
                    const imgUrl = randomOffer['img'];
                    if (imgUrl) {
                        contentImage.src = imgUrl;
                    } else {
                        contentImage.src = "https://placehold.co/120x120/E0E0E0/808080?text=Sem+Imagem";
                        console.warn("Nenhuma URL de imagem válida encontrada para esta oferta.");
                    }
                }
                if (ctaButton) {
                    // Usa a chave exata 'offer link' para o link do botão
                    ctaButton.href = randomOffer['offer link'] || "#";
                }
            }
        }

        function fetchOffersAndStartRotation() {
            fetch(offersCsvUrl)
                .then(response => {
                    if (!response.ok) throw new Error(`Erro HTTP! Status: ${response.status}`);
                    return response.text();
                })
                .then(csvText => {
                    const lines = csvText.split('\n');
                    const headers = parseCsvLine(lines[0]).map(header => header.trim());
                    
                    offersData = [];
                    // Encontra os índices das colunas para garantir o carregamento correto
                    const nameIndex = headers.findIndex(h => h.toLowerCase() === 'item name');
                    const linkIndex = headers.findIndex(h => h.toLowerCase() === 'offer link');
                    const imgIndex = headers.findIndex(h => h.toLowerCase() === 'img');

                    for (const line of lines.slice(1)) {
                        const values = parseCsvLine(line);
                        
                        // Garante que a linha tem dados suficientes
                        if (values.length >= headers.length) {
                            let offerData = {};
                            // Cria um objeto de dados com base nos índices encontrados
                            if (nameIndex !== -1) offerData['item name'] = values[nameIndex];
                            if (linkIndex !== -1) offerData['offer link'] = values[linkIndex];
                            if (imgIndex !== -1) offerData['img'] = values[imgIndex];

                            offersData.push(offerData);
                        }
                    }
                    console.log(`Dados da nova tabela de ofertas carregados. Total de ofertas: ${offersData.length}`);
                    updateOffer(); // Exibe a primeira oferta imediatamente
                    setInterval(updateOffer, 15000); // Inicia a rotação a cada 15 segundos
                })
                .catch(error => {
                    console.error("Erro ao carregar a tabela de ofertas:", error);
                    // Pode adicionar um feedback visual para o usuário se a rotação falhar
                });
        }

        // Função principal para buscar e exibir os dados do iframe (mantida)
        function fetchData() {
            loadingContainer.style.display = 'flex';
            errorContainer.style.display = 'none';

            console.log(`Buscando dados para o ID: '${idFromUrl}'...`);

            fetch(mainCsvUrl)
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`Erro HTTP! Status: ${response.status}`);
                    }
                    return response.text();
                })
                .then(csvText => {
                    loadingContainer.style.display = 'none';
                    
                    const lines = csvText.split('\n');
                    const headers = parseCsvLine(lines[0]).map(header => header.trim());
                    
                    const idColumnIndex = headers.findIndex(header => header.toLowerCase() === 'id');
                    if (idColumnIndex === -1) {
                        console.error("Erro: A coluna 'id' não foi encontrada no seu CSV.");
                        throw new Error("Missing 'id' column in CSV");
                    }

                    let rowData = null;
                    const dataLines = lines.slice(1);
                    
                    for (const line of dataLines) {
                        const values = parseCsvLine(line);
                        
                        if (values.length > idColumnIndex) {
                            const currentId = values[idColumnIndex].trim();
                            
                            if (currentId === idFromUrl.trim()) {
                                rowData = {};
                                headers.forEach((header, index) => {
                                    rowData[header] = values[index];
                                });
                                console.log("Dados correspondentes encontrados:", rowData);
                                break;
                            }
                        }
                    }

                    if (!rowData) {
                        console.log(`Nenhum dado encontrado para o ID: '${idFromUrl}'.`);
                        throw new Error("ID not found in CSV");
                    }

                    const pageTitleElement = document.querySelector('head title');
                    const titleFromCSV = rowData.título || rowData.titulo;
                    if (pageTitleElement && titleFromCSV) {
                        pageTitleElement.textContent = titleFromCSV;
                    }

                    const iframeElement = document.querySelector('#iframe-area .widget-content iframe');
                    const iframeLinkFromCSV = rowData.link_chamada;
                    if (iframeElement && iframeLinkFromCSV) {
                        iframeElement.src = iframeLinkFromCSV;
                        iframeElement.title = titleFromCSV || rowData.descricao || "Dica Top";
                    }

                    console.log(`Conteúdo do iframe atualizado para o ID: '${idFromUrl}'`);
                })
                .catch(error => {
                    console.error("Erro ao carregar ou processar o CSV:", error);
                    loadingContainer.style.display = 'none';
                    errorContainer.style.display = 'flex';
                });
        }

        // Chamada inicial
        if (idFromUrl) {
            fetchData();
        }
        fetchOffersAndStartRotation();
        
        retryButton.addEventListener('click', fetchData);
    });
    </script>
</body>
</html>
